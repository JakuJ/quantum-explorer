@using Microsoft.Extensions.Logging
@using Common
@inject ILogger<Cell> Logger;

<SnapPoint X="@X" Y="@Y" Half="@false" @ref="snapPoint" Locked="@(QuantumGate.HasValue)"/>
<div class="grid-cell">
    @if (QuantumGate.HasValue)
    {
        <Gate Name="@(QuantumGate.Value.Name)" @ref="gate" ClickAction="OnClick"/>
    }
    else
    {
        <button class="grid-blankcell-button" @onclick="OnClick"/>
    }
</div>
@if(clicked)
{
    @if(QuantumGate.HasValue)
    {
        <DeleteGateMenu ExitMenu="@ExitDeleteGateMenu" Left="@(50*X)"/>
    }
    else
    {
        <AddGateMenu ExitMenu="@ExitAddGateMenu" Left="@(50*X)"/>
    }
}

@code {

    private Gate? gate;

    private SnapPoint snapPoint = null!;

    private bool clicked { get; set; } = false;

    [Parameter]
    public QuantumGate? QuantumGate { get; set; }

    [Parameter]
    public int X { get; set; }

    [Parameter]
    public int Y { get; set; }

    [Parameter]
    public Dictionary<string, SnapPoint> SnapPoints { get; set; } = null!;

    [Parameter]
    public Action<string, string> AddGate { get; set; } = null!;

    [Parameter]
    public Action<string> DeleteGate { get; set; } = null!;

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            SnapPoints.Add(snapPoint.Id, snapPoint);
        }

        if (gate != null)
        {
            SnapPoints[gate.Id] = snapPoint;
        }
    }

    private void OnClick()
    {
        Logger.LogDebug($"Click cell  X={X}  Y={Y}");
        clicked = true;
        StateHasChanged();
    }

    private void ExitAddGateMenu(string? gateName)
    {
        if(gateName != null)
        {
            // Add a new gate with given name to this cell.
            Logger.LogDebug($"Adding gate {0}", gateName);
            AddGate?.Invoke(gateName, snapPoint.Id);
        }

        clicked = false;
        StateHasChanged();
    }

    private void ExitDeleteGateMenu(bool deleteGate)
    {
        if(deleteGate)
        {
            // Delete the gate
            Logger.LogDebug($"Deleting gate {0} {1}", gate?.Id, gate?.Name);
            DeleteGate?.Invoke(snapPoint.Id);
        }

        clicked = false;
        StateHasChanged();
    }
}
