@using Common
@using Microsoft.Extensions.Logging
@using System.Diagnostics.CodeAnalysis
@inject IJSRuntime JsRuntime
@inject ILogger<Grid> Logger;
@implements IDisposable

<div class="grid-outer-container">
    @for (var x = 0; x < gates.GetLength(0); x++)
    {
        @for (var y1 = 0; y1 < gates.GetLength(1); y1++)
        {
            QuantumGate? g1 = gates[x, y1];
            @if (g1.HasValue && g1.Value.Namespace == "__custom__" && g1.Value.Name == "__control__")
            {
                @for (var y2 = 0; y2 < gates.GetLength(1); y2++)
                {
                    QuantumGate? g2 = gates[x, y2];
                    @if (g2.HasValue && g2.Value.Name != "__control__")
                    {
                        int tempy1 = y1, tempy2 = y2;
                        if (y2 < y1)
                        {
                            tempy1 = y2;
                            tempy2 = y1;
                        }
                        int xPix = 90 + 50 * x + 2;
                        int y1Pix = 50 * tempy1 + 27;
                        int y2Pix = 50 * (tempy2 - tempy1);
                        <div class="line-container" style="position: absolute;">
                            <Line Y1="0" Y2="@y2Pix" Left="@xPix" Top="y1Pix"/>
                        </div>
                        Logger.LogDebug("Controlled gate: {0} {1} {2}", x, tempy1, tempy2);
                    }
                }
            }
        }
    }
    <div class="grid-container">
        @for (var y = 0; y < gates.GetLength(1); y++)
        {
            <div class="grid-outer-row">
                <RowID Name="@(GateGrid.Names[y])"/>
                <div class="grid-row">
                    <Line X1="0" X2="@(50 * GateGrid.Width + 10)"/>
                    @for (var x = 0; x < gates.GetLength(0); x++)
                    {
                        // Snap point between the cells
                        <SnapPoint X="@x" Y="@y" Half="@true" @ref="SnapRef"/>

                        QuantumGate? localQGate = gates[x, y];

                        <Cell X="@x" Y="@y" QuantumGate="@localQGate" SnapPoints="@snapPoints"/>
                    }
                </div>
            </div>
        }
    </div>
</div>

@code {

    [Parameter]
    public GateGrid GateGrid { get; set; } = null!;

    private Dictionary<string, SnapPoint> snapPoints = new();

    private SnapPoint SnapRef
    {
        set => snapPoints.Add(value.Id, value);
    }

    private QuantumGate?[,] gates = null!;

    private DotNetObjectReference<Grid>? reference;

    protected override void OnParametersSet()
    {
        gates = RefreshGateArray();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            reference = DotNetObjectReference.Create(this);
            await JsRuntime.InvokeVoidAsync("Library.setReference", reference);
        }

        await JsRuntime.InvokeVoidAsync("Library.initGrids");
    }

    public void Dispose()
    {
        GC.SuppressFinalize(this);
        reference?.Dispose();
    }

    [ExcludeFromCodeCoverage] // Reason: called by JS functions, awaiting E2E tests
    [JSInvokable]
    public void Expand(string gateId, string snapId)
    {
        SnapPoint oldSnap = snapPoints[gateId];
        SnapPoint newSnap = snapPoints[snapId];

        Logger.LogDebug("Expanding at snap {0}", newSnap);

        GateGrid.InsertColumn(newSnap.X + 1);
        GateGrid.MoveGate(oldSnap.X + (newSnap.X < oldSnap.X ? 1 : 0), oldSnap.Y, newSnap.X + 1, newSnap.Y);

        ForceRerender();
    }

    [ExcludeFromCodeCoverage] // Reason: called by JS functions, awaiting E2E tests
    [JSInvokable]
    public void Move(string gateId, string snapId)
    {
        SnapPoint oldSnap = snapPoints[gateId];
        SnapPoint newSnap = snapPoints[snapId];

        Logger.LogDebug("Moving the gate from snap {0} to snap {1}", oldSnap, newSnap);

        GateGrid.MoveGate(oldSnap.X, oldSnap.Y, newSnap.X, newSnap.Y);

        ForceRerender();
    }

    private QuantumGate?[,] RefreshGateArray()
    {
        var arr = new QuantumGate?[GateGrid.Width, GateGrid.Height];
        foreach ((QuantumGate gate, int x, int y) in GateGrid.Gates)
        {
            arr[x, y] = gate;
        }
        return arr;
    }

    private void ForceRerender()
    {
        gates = new QuantumGate?[gates.GetLength(0), gates.GetLength(1)];
        StateHasChanged();

        gates = RefreshGateArray();
        StateHasChanged();
    }

}
