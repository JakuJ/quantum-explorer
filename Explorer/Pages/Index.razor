@page "/"
@using Explorer.Utilities.ComponentTree
@using Newtonsoft.Json
@using Compiler
@using System.IO
@using System.Diagnostics
@inject IJSRuntime JsRuntime;

<div id="splitPanes">
    @Components
</div>

@code {
    Editor editor;
    Visualizer visualizer;

    RenderFragment Components => new PanelRenderer().Render(tree);

    readonly PanelTree tree = new PanelTree(PanelTree.Alignment.Horizontal);

    protected override void OnInitialized()
    {
        base.OnInitialized();
        tree.AddPanel<Editor>();

        var sidePanel = new PanelTree(PanelTree.Alignment.Vertical);
        sidePanel.AddPanel<Compositor>();
        sidePanel.AddPanel<Visualizer>();

        tree.AddPanel(sidePanel);
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (!firstRender) return;

        string serializedTree = JsonConvert.SerializeObject(tree, new JsonSerializerSettings
        {
            TypeNameHandling = TypeNameHandling.Auto
        });
        JsRuntime.InvokeVoidAsync("Library.InitializeSplitPanes", serializedTree);

        await JsRuntime.InvokeVoidAsync("Library.InitializeSplitPanes");

        ICompiler compiler = new Compiler();
        string path = Path.Combine(Environment.CurrentDirectory, "../QSharpTestSources/Library.qs");
        string code = await File.ReadAllTextAsync(path);
        await compiler.Compile(code);

        editor.Code = compiler.GetCode();
    }

}
